{"version":3,"sources":["assets\\scripts\\Joystick.js"],"names":["_JoystickEnum","_interopRequireDefault","require","_JoystickEvent","obj","__esModule","cc","Class","Component","properties","dot","type","Node","displayName","tooltip","ring","joystickType","JoystickEnum","JoystickType","FIXED","directionType","DirectionType","ALL","_stickPos","_touchLocation","onLoad","_radius","width","_initTouchEvent","FOLLOW","node","opacity","onEnable","JoystickEvent","getInstance","on","JoystickEventType","CHANGE_JOYSTICK_TYPE","_onChangeJoystickType","onDisable","off","EventType","TOUCH_START","_touchStartEvent","TOUCH_MOVE","_touchMoveEvent","TOUCH_END","_touchEndEvent","TOUCH_CANCEL","event","emit","touchPos","convertToNodeSpaceAR","getLocation","getPosition","distance","sub","mag","setPosition","posX","x","posY","y","p","v2","normalize","speedType","SpeedType","NORMAL","FAST","moveDistance","STOP"],"mappings":"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","sourceRoot":"/","sourcesContent":["import JoystickEnum from 'JoystickEnum';\r\nimport JoystickEvent from 'JoystickEvent';\r\n\r\ncc.Class({\r\n    extends: cc.Component,\r\n\r\n    properties: {\r\n        dot: {\r\n            default: null,\r\n            type: cc.Node,\r\n            displayName: 'Dot',\r\n            tooltip: '摇杆操纵点',\r\n        },\r\n        ring: {\r\n            default: null,\r\n            type: cc.Node,\r\n            displayName: 'Ring',\r\n            tooltip: '摇杆背景节点',\r\n        },\r\n\r\n        joystickType: {\r\n            default: JoystickEnum.JoystickType.FIXED,\r\n            type: JoystickEnum.JoystickType,\r\n            displayName: 'Touch Type',\r\n            tooltip: '触摸类型',\r\n        },\r\n\r\n        directionType: {\r\n            default: JoystickEnum.DirectionType.ALL,\r\n            type: JoystickEnum.DirectionType,\r\n            displayName: 'Direction Type',\r\n            tooltip: '方向类型',\r\n        },\r\n\r\n        _stickPos: {\r\n            default: null,\r\n            type: cc.Node,\r\n            tooltip: '摇杆所在位置',\r\n        },\r\n        _touchLocation: {\r\n            default: null,\r\n            type: cc.Node,\r\n            tooltip: '触摸位置',\r\n        },\r\n    },\r\n\r\n    onLoad() {\r\n        this._radius = this.ring.width / 2;\r\n        this._initTouchEvent();\r\n        // hide joystick when follow\r\n        if (this.joystickType === JoystickEnum.JoystickType.FOLLOW) {\r\n            this.node.opacity = 0;\r\n        }\r\n    },\r\n\r\n    onEnable() {\r\n        JoystickEvent.getInstance().on(JoystickEnum.JoystickEventType.CHANGE_JOYSTICK_TYPE, this._onChangeJoystickType, this);\r\n    },\r\n\r\n    onDisable() {\r\n        JoystickEvent.getInstance().off(JoystickEnum.JoystickEventType.CHANGE_JOYSTICK_TYPE, this._onChangeJoystickType, this);\r\n    },\r\n\r\n    _onChangeJoystickType(type) {\r\n        this.joystickType = type;\r\n        this.node.opacity = type === JoystickEnum.JoystickType.FIXED ? 255 : 0;\r\n    },\r\n\r\n    _initTouchEvent() {\r\n        // set the size of joystick node to control scale\r\n        this.node.on(cc.Node.EventType.TOUCH_START, this._touchStartEvent, this);\r\n        this.node.on(cc.Node.EventType.TOUCH_MOVE, this._touchMoveEvent, this);\r\n        this.node.on(cc.Node.EventType.TOUCH_END, this._touchEndEvent, this);\r\n        this.node.on(cc.Node.EventType.TOUCH_CANCEL, this._touchEndEvent, this);\r\n    },\r\n\r\n    _touchStartEvent(event) {\r\n        JoystickEvent.getInstance().emit(JoystickEnum.JoystickEventType.TOUCH_START, \"joystick touch start\", 10);\r\n        const touchPos = this.node.convertToNodeSpaceAR(event.getLocation());\r\n\r\n        if (this.joystickType === JoystickEnum.JoystickType.FIXED) {\r\n            this._stickPos = this.ring.getPosition();\r\n\r\n            // 触摸点与圆圈中心的距离\r\n            const distance = touchPos.sub(this.ring.getPosition()).mag();\r\n\r\n            // 手指在圆圈内触摸,控杆跟随触摸点\r\n            this._radius > distance && this.dot.setPosition(touchPos);\r\n\r\n        } else if (this.joystickType === JoystickEnum.JoystickType.FOLLOW) {\r\n\r\n            // 记录摇杆位置，给 touch move 使用\r\n            this._stickPos = touchPos;\r\n            this.node.opacity = 255;\r\n            this._touchLocation = event.getLocation();\r\n\r\n            // 更改摇杆的位置\r\n            this.ring.setPosition(touchPos);\r\n            this.dot.setPosition(touchPos);\r\n        }\r\n    },\r\n\r\n    _touchMoveEvent(event) {\r\n        // 如果 touch start 位置和 touch move 相同，禁止移动\r\n        if (this.joystickType === JoystickEnum.JoystickType.FOLLOW && this._touchLocation === event.getLocation()) {\r\n            return false;\r\n        }\r\n\r\n        // 以圆圈为锚点获取触摸坐标\r\n        const touchPos = this.ring.convertToNodeSpaceAR(event.getLocation());\r\n        const distance = touchPos.mag();\r\n\r\n        // 由于摇杆的 postion 是以父节点为锚点，所以定位要加上 touch start 时的位置\r\n        const posX = this._stickPos.x + touchPos.x;\r\n        const posY = this._stickPos.y + touchPos.y;\r\n\r\n        // 归一化\r\n        const p = cc.v2(posX, posY).sub(this.ring.getPosition()).normalize();\r\n\r\n        let speedType;\r\n\r\n        if (this._radius > distance) {\r\n            this.dot.setPosition(cc.v2(posX, posY));\r\n\r\n            speedType = JoystickEnum.SpeedType.NORMAL;\r\n        } else {\r\n            // 控杆永远保持在圈内，并在圈内跟随触摸更新角度\r\n            const x = this._stickPos.x + p.x * this._radius;\r\n            const y = this._stickPos.y + p.y * this._radius;\r\n            this.dot.setPosition(cc.v2(x, y));\r\n\r\n            speedType = JoystickEnum.SpeedType.FAST;\r\n        }\r\n\r\n        JoystickEvent.getInstance().emit(JoystickEnum.JoystickEventType.TOUCH_MOVE, event, {speedType: speedType, moveDistance: p});\r\n    },\r\n\r\n    _touchEndEvent(event) {\r\n        this.dot.setPosition(this.ring.getPosition());\r\n        if (this.joystickType === JoystickEnum.JoystickType.FOLLOW) {\r\n            this.node.opacity = 0;\r\n        }\r\n\r\n        JoystickEvent.getInstance().emit(JoystickEnum.JoystickEventType.TOUCH_END, event, {speedType: JoystickEnum.SpeedType.STOP});\r\n    },\r\n\r\n});\r\n"]}